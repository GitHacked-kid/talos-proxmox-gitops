apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: hikmah-db
  namespace: postgres
spec:
  postgresVersion: 16

  # Application user and database
  users:
    - name: appuser
      databases: ["hikmahdb"]
      options: "SUPERUSER"  # Adjust privileges as needed
    - name: dagster-user
      databases: ["dagster-metadata"]
      options: "SUPERUSER"  # Needed for Dagster schema management

  # Note: No pgBackRest backup configuration
  # Backups handled by Longhorn volume snapshots to NFS
  # See LONGHORN-PLAN.md for backup configuration details

  instances:
    # Single instance with Longhorn 2-way replication
    - name: primary
      replicas: 1  # Single PostgreSQL instance (HA provided by Longhorn)
      dataVolumeClaimSpec:
        storageClassName: longhorn  # Longhorn with 2-way replication
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 100Gi  # 100GB usable, 200GB raw (2x replication) - Main instance
      # No node affinity - Longhorn data is distributed, pod can run anywhere
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          cpu: "2000m"
          memory: "4Gi"

  # Patroni configuration for PostgreSQL HA
  patroni:
    dynamicConfiguration:
      postgresql:
        parameters:
          # Connection settings
          max_connections: 200

          # Memory settings (optimized for 4GB limit)
          shared_buffers: "1GB"
          effective_cache_size: "3GB"
          maintenance_work_mem: "256MB"
          work_mem: "5MB"

          # WAL settings
          wal_buffers: "16MB"
          checkpoint_completion_target: "0.9"

          # Query planner
          random_page_cost: 1.1  # SSD-optimized (Longhorn on SSD)
          effective_io_concurrency: 200  # SSD-optimized

          # Autovacuum
          autovacuum_max_workers: 3
          autovacuum_naptime: "1min"

          # Logging
          log_min_duration_statement: "1000"  # Log queries slower than 1s
          log_line_prefix: "%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "

          # WAL archiving (disabled - using Longhorn backups)
          archive_mode: "off"

          # Performance tuning
          max_wal_size: "4GB"
          min_wal_size: "1GB"

  # Monitoring (integrates with existing Prometheus)
  monitoring:
    pgmonitor:
      exporter:
        image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres-exporter:ubi8-5.6.0-0

  # Expose primary via LoadBalancer for external access (MetalLB only)
  service:
    type: LoadBalancer
    metadata:
      annotations:
        # Disable k3s servicelb for this service, use MetalLB only
        svccontroller.k3s.cattle.io/enablelb: "false"
