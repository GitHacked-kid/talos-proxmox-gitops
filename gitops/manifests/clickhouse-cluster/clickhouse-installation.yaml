apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  name: hikmah-ch
  namespace: clickhouse-operator
spec:
  # Default configuration for all ClickHouse instances
  defaults:
    templates:
      dataVolumeClaimTemplate: data-volume
      logVolumeClaimTemplate: log-volume
      serviceTemplate: chi-service-template
      podTemplate: clickhouse-pod-template

  configuration:
    # Single standalone server (not a cluster)
    clusters:
      - name: hikmah
        layout:
          shardsCount: 1
          replicasCount: 1  # Single instance (HA via Longhorn)

    # Users configuration
    users:
      # Default user (for backward compatibility)
      default/password: ""
      default/networks/ip:
        - "127.0.0.1/32"
        - "::1/128"

      # Application user with full access
      appuser/password: "eoT7848iSdSCVBYuPUGgz9Wfx5ibp2iW1mZQ4sIQzTY="
      appuser/networks/ip:
        - "::/0"             # Allow from any IPv6
        - "0.0.0.0/0"        # Allow from any IPv4
      appuser/profile: default
      appuser/quota: default
      appuser/access_management: 1

    # User profiles with settings
    profiles:
      default/max_memory_usage: 8589934592  # 8GB
      default/max_memory_usage_for_user: 8589934592
      default/max_execution_time: 300  # 5 minutes
      default/max_query_size: 1048576  # 1MB
      default/max_threads: 8
      default/log_queries: 1
      default/log_query_threads: 1
      default/network_compression_method: lz4

    # Server-level settings (not user-level)
    settings:
      max_concurrent_queries: 100

    # Files section for additional configuration
    files:
      # Enable Prometheus metrics endpoint
      config.d/prometheus.xml: |
        <clickhouse>
          <prometheus>
            <endpoint>/metrics</endpoint>
            <port>9363</port>
            <metrics>true</metrics>
            <events>true</events>
            <asynchronous_metrics>true</asynchronous_metrics>
            <status_info>true</status_info>
          </prometheus>
        </clickhouse>

  # Volume claim templates
  templates:
    volumeClaimTemplates:
      - name: data-volume
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: longhorn  # Longhorn with 2-way replication
          resources:
            requests:
              storage: 200Gi  # 200GB usable, 400GB raw (2x replication)

      - name: log-volume
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: longhorn
          resources:
            requests:
              storage: 10Gi  # 10GB usable, 20GB raw (2x replication)

    # Service template for LoadBalancer
    serviceTemplates:
      - name: chi-service-template
        generateName: clickhouse-{chi}
        spec:
          type: LoadBalancer
          ports:
            - name: http
              port: 8123
              targetPort: 8123
              protocol: TCP
            - name: tcp
              port: 9000
              targetPort: 9000
              protocol: TCP
            - name: metrics
              port: 9363
              targetPort: 9363
              protocol: TCP
        metadata:
          annotations:
            # Disable k3s servicelb for this service, use MetalLB only
            svccontroller.k3s.cattle.io/enablelb: "false"

    # Pod template
    podTemplates:
      - name: clickhouse-pod-template
        spec:
          containers:
            - name: clickhouse
              image: clickhouse/clickhouse-server:24.11-alpine  # Latest LTS
              resources:
                requests:
                  cpu: "1000m"
                  memory: "4Gi"
                limits:
                  cpu: "4000m"
                  memory: "12Gi"