apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ingress-nginx
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: ingress-nginx
  source:
    repoURL: https://kubernetes.github.io/ingress-nginx
    chart: ingress-nginx
    targetRevision: 4.13.2
    helm:
      values: |
        controller:
          # SSL Configuration
          config:
            # Redirect HTTP to HTTPS
            ssl-redirect: "true"
            force-ssl-redirect: "true"
            # Use secure ciphers
            ssl-ciphers: "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384"
            ssl-protocols: "TLSv1.2 TLSv1.3"
            # HSTS (HTTP Strict Transport Security)
            hsts: "true"
            hsts-max-age: "31536000"
            hsts-include-subdomains: "true"
            hsts-preload: "true"
            # Security headers
            enable-ocsp-stapling: "true"
            # SSL Session Cache
            ssl-session-cache: "shared:SSL:10m"
            ssl-session-timeout: "10m"
            ssl-session-tickets: "false"

          # Service configuration
          service:
            type: LoadBalancer
            externalTrafficPolicy: Local  # Better for real client IPs

          # Metrics
          metrics:
            enabled: true
            serviceMonitor:
              enabled: true
              namespace: monitoring
              additionalLabels:
                release: prometheus-stack

          # Admission Webhooks
          admissionWebhooks:
            patch:
              enabled: true

        defaultBackend:
          enabled: true
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true