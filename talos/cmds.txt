https://mirceanton.com/posts/the-best-os-for-kubernetes/

talosctl gen secrets

talosctl gen config tc-cluster https://10.20.0.50:6443 \
--with-secrets secrets.yaml \
--config-patch-control-plane @vip.yaml \
--config-patch @allowcontrolplanes.yaml

talosctl gen config homelab-cluster https://$CONTROL_PLANE_IP:6443 \
--with-secrets secrets.yaml \
--config-patch @cni.yaml \
--config-patch @kubernetes-certificates.yaml \
--output rendered

talosctl apply-config --insecure --nodes $CONTROL_PLANE_IP --file rendered/controlplane.yaml
talosctl apply-config --insecure --nodes $WORKER1_IP --file rendered/worker.yaml 
talosctl apply-config --insecure --nodes $WORKER2_IP --file rendered/worker.yaml 

export CONTROL_PLANE_IP=10.20.0.221
export WORKER1_IP=10.20.0.131
export WORKER2_IP=10.20.0.176
export TALOSCONFIG="rendered/talosconfig"
talosctl config endpoint $CONTROL_PLANE_IP
talosctl config node $CONTROL_PLANE_IP

talosctl kubeconfig rendered/kubeconfig
talosctl bootstrap

helm repo add cilium https://helm.cilium.io/
helm repo update
with kube-proxy
helm install \
    cilium \
    cilium/cilium \
    --version 1.18.0 \
    --namespace kube-system \
    --set ipam.mode=kubernetes \
    --set kubeProxyReplacement=false \
    --set securityContext.capabilities.ciliumAgent="{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}" \
    --set securityContext.capabilities.cleanCiliumState="{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}" \
    --set cgroup.autoMount.enabled=false \
    --set cgroup.hostRoot=/sys/fs/cgroup

without kube-proxy
helm install \
    cilium \
    cilium/cilium \
    --version 1.18.0 \
    --namespace kube-system \
    --set ipam.mode=kubernetes \
    --set kubeProxyReplacement=true \
    --set securityContext.capabilities.ciliumAgent="{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}" \
    --set securityContext.capabilities.cleanCiliumState="{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}" \
    --set cgroup.autoMount.enabled=false \
    --set cgroup.hostRoot=/sys/fs/cgroup \
    --set k8sServiceHost=localhost \
    --set k8sServicePort=7445

kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
