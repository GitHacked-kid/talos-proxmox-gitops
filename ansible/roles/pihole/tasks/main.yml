---
# Pi-hole DNS Server Installation and Configuration
# Network-wide ad blocking and DNS server

- name: Update system packages
  apt:
    update_cache: true
    upgrade: dist
  become: true

- name: Install prerequisites
  apt:
    name:
      - curl
      - wget
      - sudo
      - lsof
      - netstat-nat
      - dnsutils
      - whois
    state: present
  become: true

- name: Ensure time synchronization is handled by host system
  shell: |
    systemctl mask systemd-timesyncd || true
    echo "Time sync managed by LXC host system"
  become: true
  ignore_errors: true

- name: Create pihole user
  user:
    name: pihole
    system: true
    shell: /usr/sbin/nologin
    home: /opt/pihole
    create_home: true
  become: true

- name: Create Pi-hole directories
  file:
    path: "{{ item }}"
    state: directory
    owner: pihole
    group: pihole
    mode: '0755'
  loop:
    - /etc/pihole
    - /opt/pihole
    - /var/log/pihole
  become: true

- name: Download Pi-hole installation script
  get_url:
    url: https://install.pi-hole.net
    dest: /tmp/pihole-install.sh
    mode: '0755'
  become: true

- name: Create Pi-hole setup configuration
  template:
    src: setupVars.conf.j2
    dest: /etc/pihole/setupVars.conf
    owner: pihole
    group: pihole
    mode: '0644'
  become: true

- name: Install Pi-hole unattended
  shell: |
    cd /tmp
    bash pihole-install.sh --unattended
  become: true
  args:
    creates: /usr/local/bin/pihole

- name: Set Pi-hole web admin password
  shell: |
    pihole -a -p {{ pihole_admin_password | default('homelab123') }}
  become: true
  no_log: true

- name: Disable Pi-hole NTP sync (fixes LXC container permissions issue)
  shell: |
    pihole-FTL --config ntp.sync.interval 0
  become: true
  ignore_errors: true

- name: Configure Pi-hole DNS settings
  template:
    src: 01-pihole.conf.j2
    dest: /etc/dnsmasq.d/01-pihole.conf
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: restart pihole-FTL

- name: Enable and start Pi-hole service
  systemd:
    name: pihole-FTL
    enabled: true
    state: started
  become: true

- name: Wait for Pi-hole to be fully ready
  wait_for:
    port: 53
    host: localhost
    timeout: 60
  become: true

- name: Update Pi-hole gravity database (blocklists)
  shell: pihole -g
  become: true
  register: gravity_update

- name: Display gravity update results
  debug:
    msg: "Gravity database updated - {{ gravity_update.stdout_lines | select('match', '.*domains.*') | list }}"

- name: Configure firewall for Pi-hole
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: "{{ protocol }}"
  loop:
    - { port: "53", protocol: "tcp" }
    - { port: "53", protocol: "udp" }
    - { port: "80", protocol: "tcp" }
    - { port: "443", protocol: "tcp" }
  become: true
  ignore_errors: true
  vars:
    protocol: "{{ item.protocol }}"

- name: Add custom blocklists
  shell: |
    pihole -w {{ item }}
  loop:
    - "github.com"
    - "raw.githubusercontent.com"
    - "docker.io"
  become: true
  ignore_errors: true

- name: Display Pi-hole status
  shell: pihole status
  register: pihole_status
  become: true

- name: Show Pi-hole installation summary
  debug:
    msg: |
      üõ°Ô∏è  Pi-hole DNS Server Setup Complete!
      
      ‚úÖ Pi-hole Admin Panel: http://{{ ansible_default_ipv4.address }}/admin
      ‚úÖ DNS Server: {{ ansible_default_ipv4.address }}:53
      ‚úÖ Admin Password: {{ pihole_admin_password | default('homelab123') }}
      
      üìä Status: {{ pihole_status.stdout }}
      
      üîß Configuration:
      - Upstream DNS: Cloudflare (1.1.1.1, 1.0.0.1)
      - Web Interface: Port 80
      - DNS Port: 53 (TCP/UDP)
      
      üí° Next Steps:
      1. Configure router to use {{ ansible_default_ipv4.address }} as DNS
      2. Or set DNS manually on devices: {{ ansible_default_ipv4.address }}
      3. Access admin panel to customize blocklists
      
      üö´ Network-wide ad blocking is now active!