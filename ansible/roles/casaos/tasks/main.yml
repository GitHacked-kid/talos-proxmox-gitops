---
# CasaOS Installation and Configuration
# Comprehensive media server setup with NFS integration

- name: Update system packages
  apt:
    update_cache: true
    upgrade: dist
  become: true

- name: Install prerequisites
  apt:
    name:
      - curl
      - wget
      - gnupg2
      - apt-transport-https
      - ca-certificates
      - lsb-release
      - nfs-common
      - python3-docker
    state: present
  become: true

- name: Create media directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  loop:
    - /home/{{ ansible_user }}/media
    - /home/{{ ansible_user }}/media/movies
    - /home/{{ ansible_user }}/media/tv
    - /home/{{ ansible_user }}/media/music
    - /home/{{ ansible_user }}/media/downloads
    - /home/{{ ansible_user }}/jellyfin-config
    - /home/{{ ansible_user }}/qbittorrent-config

- name: Mount NFS share for media storage
  mount:
    path: /home/{{ ansible_user }}/media
    src: "{{ nfs_server_ip }}:/srv/nfs/media"
    fstype: nfs4
    opts: defaults,rw,hard,intr
    state: mounted
  become: true
  when: nfs_server_ip != "TBD"

- name: Download CasaOS installation script
  get_url:
    url: https://get.casaos.io
    dest: /tmp/casaos-install.sh
    mode: '0755'
  become: true

- name: Install CasaOS with Docker already available
  shell: |
    cd /tmp
    bash casaos-install.sh
  become: true
  args:
    creates: /usr/bin/casaos
  # environment:
  #   SKIP_DOCKER_INSTALL: "1"

- name: Display CasaOS information
  debug:
    msg: |
      ğŸ‰ CasaOS Media Server Setup Complete!
      
      âœ… CasaOS Dashboard: http://{{ ansible_default_ipv4.address }}
      âœ… Docker installed and running
      âœ… NFS media storage mounted at /home/{{ ansible_user }}/media
      
      ğŸ“‚ Media directories ready:
      - Movies: /home/{{ ansible_user }}/media/movies
      - TV Shows: /home/{{ ansible_user }}/media/tv  
      - Music: /home/{{ ansible_user }}/media/music
      - Downloads: /home/{{ ansible_user }}/media/downloads
      
      ğŸ³ Use CasaOS web interface to install:
      - Jellyfin (Media Server)
      - qBittorrent (Torrent Client)
      - Sonarr/Radarr (Media Management)
      
      ğŸ’¡ First login to CasaOS will require initial setup