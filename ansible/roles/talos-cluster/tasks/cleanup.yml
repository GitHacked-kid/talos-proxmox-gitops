---
# Cleanup Talos VMs on failure
# This task file is called when any step in the Talos cluster setup fails

- name: Display cleanup warning
  ansible.builtin.debug:
    msg: |
      ⚠️  Talos cluster setup failed!
      ⚠️  Cleaning up all Talos VMs...

- name: Read Proxmox credentials from environment
  ansible.builtin.set_fact:
    proxmox_api_host: "{{ lookup('env', 'PROXMOX_API_URL') | regex_replace('^https?://', '') | regex_replace('/.*$', '') }}"
    proxmox_api_user: "{{ lookup('env', 'PROXMOX_API_TOKEN_ID') }}"
    proxmox_api_token: "{{ lookup('env', 'PROXMOX_API_TOKEN_SECRET') }}"

- name: Destroy control plane VM
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_user.split('!')[1] if '!' in proxmox_api_user else proxmox_api_user }}"
    api_token_secret: "{{ proxmox_api_token }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ talos_nodes.control_plane.vmid }}"
    state: absent
    force: true
  ignore_errors: true
  register: destroy_cp

- name: Destroy worker VMs
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_user.split('!')[1] if '!' in proxmox_api_user else proxmox_api_user }}"
    api_token_secret: "{{ proxmox_api_token }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ item.vmid }}"
    state: absent
    force: true
  loop: "{{ talos_nodes.workers }}"
  ignore_errors: true
  register: destroy_workers

- name: Clean up Talos configuration directory
  ansible.builtin.file:
    path: "{{ talos_config_dir }}"
    state: absent
  ignore_errors: true

- name: Display cleanup result
  ansible.builtin.debug:
    msg: |
      ✓ Cleanup completed
      ✓ All Talos VMs have been destroyed
      ✓ Configuration directory cleaned up
