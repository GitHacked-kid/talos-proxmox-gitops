---
# Export kubeconfig for kubectl access

- name: Export kubeconfig
  ansible.builtin.command:
    cmd: talosctl kubeconfig rendered/kubeconfig
  args:
    chdir: "{{ talos_config_dir }}"
  environment:
    TALOSCONFIG: "{{ talos_config_dir }}/rendered/talosconfig"
  changed_when: true

- name: Wait for Kubernetes API and nodes to register (3 nodes expected)
  ansible.builtin.command:
    cmd: kubectl get nodes --no-headers
  environment:
    KUBECONFIG: "{{ talos_config_dir }}/rendered/kubeconfig"
  register: nodes_status
  until: nodes_status.rc == 0 and nodes_status.stdout_lines | length == 3
  retries: 40
  delay: 15
  changed_when: false
  failed_when: false

- name: Display nodes status before CNI installation
  ansible.builtin.debug:
    msg: |
      Nodes registered with API server ({{ nodes_status.stdout_lines | length }}/3):
      {{ nodes_status.stdout }}
      ⚠️  Note: Nodes will be NotReady until Cilium CNI is installed

- name: Fail if all 3 nodes are not registered
  ansible.builtin.fail:
    msg: "Expected 3 nodes to register, but found {{ nodes_status.stdout_lines | default([]) | length }}"
  when: nodes_status.stdout_lines | default([]) | length != 3

- name: Display kubeconfig location
  ansible.builtin.debug:
    msg: "✓ Kubeconfig exported to {{ talos_config_dir }}/rendered/kubeconfig"
