---
# Export kubeconfig for kubectl access

- name: Export kubeconfig
  ansible.builtin.command:
    cmd: talosctl kubeconfig rendered/kubeconfig
  args:
    chdir: "{{ talos_config_dir }}"
  environment:
    TALOSCONFIG: "{{ talos_config_dir }}/rendered/talosconfig"
  changed_when: true

- name: Wait for all nodes to be ready in Kubernetes
  ansible.builtin.command:
    cmd: kubectl get nodes --no-headers
  environment:
    KUBECONFIG: "{{ talos_config_dir }}/rendered/kubeconfig"
  register: nodes_status
  until: >
    nodes_status.stdout_lines | length == 3 and
    nodes_status.stdout is search('NotReady') == false
  retries: 40
  delay: 15
  changed_when: false
  failed_when: false

- name: Fail if nodes are not ready
  ansible.builtin.fail:
    msg: "Nodes failed to become ready after 10 minutes"
  when: >
    nodes_status.stdout_lines | default([]) | length != 3 or
    nodes_status.stdout is search('NotReady')

- name: Display kubeconfig location
  ansible.builtin.debug:
    msg: "âœ“ Kubeconfig exported to {{ talos_config_dir }}/rendered/kubeconfig"
