---
# PostgreSQL Database Server Configuration Tasks

- name: Update apt cache
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install PostgreSQL server and client
  apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present

- name: Ensure PostgreSQL service is started and enabled
  systemd:
    name: postgresql
    state: started
    enabled: true

- name: Create homelab database
  postgresql_db:
    name: "{{ postgres_db | default('homelab') }}"
    state: present
  become: true
  become_user: postgres

- name: Create homelab database user
  postgresql_user:
    name: "{{ postgres_user | default('homelab') }}"
    password: "{{ postgres_password | default('homelab123') }}"
    state: present
  become: true
  become_user: postgres

- name: Grant db user access to database
  postgresql_privs:
    type: database
    database: "{{ postgres_db | default('homelab') }}"
    roles: "{{ postgres_user | default('homelab') }}"
    grant_option: no
    privs: all
  become: true
  become_user: postgres

- name: Find PostgreSQL version
  shell: ls /etc/postgresql/ | head -1
  register: pg_version
  changed_when: false

- name: Allow md5 connection for the db user
  postgresql_pg_hba:
    dest: "/etc/postgresql/{{ pg_version.stdout }}/main/pg_hba.conf"
    contype: host
    databases: all
    method: md5
    users: "{{ postgres_user | default('homelab') }}"
    address: 0.0.0.0/0
    create: true
  become: true
  notify: restart postgresql

- name: Configure PostgreSQL main settings
  template:
    src: postgresql.conf.j2
    dest: "/etc/postgresql/{{ pg_version.stdout }}/main/postgresql.conf"
    backup: true
  notify: restart postgresql

- name: Create backup directory
  file:
    path: /var/backups/postgresql
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Test PostgreSQL connectivity
  postgresql_query:
    db: "{{ postgres_db | default('homelab') }}"
    login_user: "{{ postgres_user | default('homelab') }}"
    login_password: "{{ postgres_password | default('homelab123') }}"
    login_host: localhost
    query: "SELECT version();"
  register: postgres_version

- name: Display PostgreSQL version
  debug:
    msg: "PostgreSQL is running: {{ postgres_version.query_result }}"